<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirigiendo Escaneo QR...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* [ESTILOS OMITIDOS PARA BREVEDAD, PERO INCLUYE EL BLOQUE COMPLETO ANTERIOR] */
    </style>
</head>
<body>
    <div class="loader"></div>
    <h1>Registro de Escaneo en Proceso...</h1>
    <p class="message">Por favor, **permita el acceso a su ubicación (GPS)** para el registro más preciso. Esto solo tarda unos segundos.</p>

    <script>
        // ***************************************************************
        // *** TU URL DE APPS SCRIPT ***
        // ***************************************************************
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyAFqhgkAklcfEFiHaYdxP54tYPvXpfucKKpI4Z--6v8Kos2OxOp0fLHN7yUVnbxYXtvA/exec';

        // -----------------------------------------------------
        // Funcion para obtener la ubicacion precisa (GPS del navegador)
        // -----------------------------------------------------
        function getPreciseLocation(timeout = 6000) {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) { return reject('GPS_No_Soportado'); }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        resolve(`GPS Lat:${lat},Lng:${lng}`);
                    },
                    (error) => {
                        let errorMessage = 'GPS_No_Capturado_Fallo_Desconocido';
                        if (error.code === 1) errorMessage = 'GPS_Permiso_Denegado';
                        else if (error.code === 2) errorMessage = 'GPS_Posicion_No_Disponible';
                        else if (error.code === 3) errorMessage = 'GPS_Timeout';
                        reject(errorMessage);
                    },
                    { enableHighAccuracy: true, timeout: timeout, maximumAge: 0 }
                );
            });
        }
        
        // -----------------------------------------------------
        // Funcion principal de rastreo
        // -----------------------------------------------------
        async function trackAndRedirect() {
            let ip = 'IP_No_Capturada';
            let locationParam = 'Ubicacion_No_Capturada';
            const userAgent = navigator.userAgent;

            // 1. Intentar obtener la ubicacion precisa (GPS)
            try {
                locationParam = await getPreciseLocation();
            } catch (error) {
                locationParam = error.toString();
                
                // 2. Fallback: Usar IPinfo para obtener IP y ubicacion aproximada
                try {
                    const response = await fetch('https://ipinfo.io/json');
                    const data = await response.json();
                    ip = data.ip || 'IP_No_Encontrada';
                    
                    if (locationParam.includes('GPS_Permiso_Denegado') || locationParam.includes('GPS_Timeout') || locationParam.includes('GPS_No_Soportado') || locationParam.includes('GPS_No_Capturado')) {
                        const city = data.city || 'Ciudad?';
                        const region = data.region || 'Region?';
                        const country = data.country || 'Pais?';
                        locationParam = `IP_Aprox: ${city}, ${region}, ${country}`;
                    }

                } catch (error) {
                    console.error("Fallo al capturar IP/Aprox Location:", error);
                }
            }

            // 3. Crear la URL final con todos los parametros y redirigir
            const finalUrl = `${APPS_SCRIPT_URL}?ip=${encodeURIComponent(ip)}&loc=${encodeURIComponent(locationParam)}&ua=${encodeURIComponent(userAgent)}`;
            window.location.replace(finalUrl);
        }

        // Se inicia la funcion
        trackAndRedirect();
    </script>
</body>
</html>

---

**¡Por favor, usa el código de arriba para reemplazar el contenido de `index.html` en GitHub y haz la prueba final con tu QR!**
